#include <openssl/sha.h>
#include <string.h>
#include <openssl/rsa.h>
#include <openssl/evp.h>
#include <stdio.h>
#include <stdlib.h>
#include <openssl/core.h>
#include <openssl/pem.h>
#include <openssl/param_build.h>
#include <openssl/bn.h>
#include <openssl/err.h>

#define SIGNATURE_SIZE 0x100
#define DIGEST_SIZE 0x20

unsigned char privkeyd[SIGNATURE_SIZE] = "\x07\xc1\x1d\x97\xf6\x90\x0c\x47\x81\x2c\x02\x05\xd9\x5f\x07\x12\x70\x9d\x86\xf9\xa2\xe8\x70\x17\x32\x5c\x9a\xb5\xf2\xd2\xe5\xe5\x34\x26\xba\x9e\x06\xf5\x82\x34\x8a\xb1\xfc\x7d\xd6\x55\x68\xb6\x37\xd7\xe9\x37\x3d\x9e\x85\x65\x52\xb5\xda\x2d\x94\x5e\x47\x20\xa9\x64\x4f\xf2\xc5\xf5\x07\xfd\x7f\x35\x9c\x01\x9a\x78\x75\xb5\x03\xa1\x1c\x9e\x29\x11\x74\x0b\x76\xc2\x2d\x6c\xd8\x61\x64\x3e\x6d\x34\xc9\x19\xdf\x82\xbc\x43\xfa\x96\x09\xcc\xdd\x51\x6f\x51\xa7\x24\x2c\x4b\xf5\x2a\x63\x5b\x4c\xf7\x5b\x8a\xd3\xba\x96\xd0\xb7\xca\x00\xb4\x43\x8c\xf5\x09\x35\xb5\x49\x68\xd5\xf1\xe8\x6d\x61\x7d\x4b\x63\xbb\xac\x7e\xb5\x92\x48\x0d\xeb\xb0\x93\x79\x80\x5c\x23\xfb\x8a\xf1\x02\x9c\x62\xa4\x05\x39\xf2\xbc\x33\x9f\xff\x37\xaf\x89\x05\xb4\x2e\xf6\x3a\x06\x79\x42\xa9\x61\xfb\x57\x49\x35\x13\x1e\x93\xa3\x77\x39\x90\x7c\xa8\x8b\x92\xa7\xd5\x2f\x96\x47\x16\x5e\x9a\xeb\x7a\xf1\x5b\xf0\x8a\xaf\xc2\x8b\x4f\x29\x5d\x8b\xed\x1e\x5b\x87\x77\x8c\xf0\xd7\x69\xd1\x00\x83\xcb\x31\x7f\x7b\xec\xc0\xe4\xbe\xec\x8e\x01\x45\x67\xf6\x20\x51\xc3\x9b\x21";

unsigned char userE[SIGNATURE_SIZE] = "\x01\x00\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00";

unsigned char userN[SIGNATURE_SIZE] = "\xc2\x36\x8b\xf2\xbf\xc6\x0c\x39\x78\xe2\x44\x9b\x2e\xaf\x07\x19\x79\x79\xe8\xb1\x4d\x26\x11\x15\xc5\xe3\x20\x72\x57\x4a\x91\xff\x1f\xc2\x84\xc1\x5a\xe8\xf9\xf2\xf5\x79\xd4\x90\x7b\x82\x53\xf6\x8b\x80\xcd\x99\xf6\xa4\xb6\x9e\xa3\x15\xdf\xd5\xe8\x2c\x67\xf3\x9b\x3f\xb6\x7f\x1d\x7a\x41\xc6\xa6\x71\xb4\x06\x26\xc4\x86\x69\x11\x0b\x8a\x05\x31\x8d\xc7\xf3\xfc\x85\x6c\x5a\x38\xe7\x42\xa7\xce\xed\x96\xa8\xb4\x62\xb6\x19\x25\xee\x7c\x8d\x39\x54\x85\x8d\x03\x47\xaa\x9f\xbf\x80\xca\x2b\xcd\x59\x02\x6a\x3b\xf4\x28\x21\x00\x92\x4b\xa3\x3a\x89\x59\xbc\x10\xdd\xdf\x32\x4e\x1d\xee\x47\x2f\x50\x28\x02\x81\xe9\x61\xad\x29\x91\x14\x65\x48\xaa\x12\x26\x2a\xcc\x32\x35\xce\x0c\x80\x4b\x48\xed\x81\x0c\x18\x94\xc4\x7f\x68\xde\x4f\xb3\x8e\x83\xab\x0a\xc1\x8c\xd4\x2a\xd3\x97\x4c\x23\x07\x7d\x77\x76\xd0\x41\x28\x67\x59\x71\x4b\x88\x4b\xb8\x45\x16\x58\xaa\x79\xea\x18\x02\x06\xbb\x81\x29\x8b\x76\xb0\xdc\xbb\x30\x88\x9b\x4e\x68\x85\x8c\x6c\x70\x61\x30\xe1\x36\xa3\x80\x55\x50\xa1\x1c\x91\x28\xad\xb9\xc3\x90\x4c\x33\x72\x10\x53\x0f\xec\x7d";

//unsigned char user_sig[SIGNATURE_SIZE] = "\x5e\xb7\x65\xcb\x63\xdb\x26\xd6\x06\x32\x02\xed\x04\xa5\x17\x43\x87\x70\x2f\xb0\xfd\x8a\xb9\x87\xec\xa6\x51\x34\x98\xa6\x9e\x50\xc2\xb1\x9a\x5e\x54\xe9\x17\x01\xd8\x65\x34\x38\x89\x52\x22\x63\x5f\x4a\x2d\xa6\x0a\xc3\x67\xa9\x54\x1d\x5f\x7a\x0c\x48\x25\xb3\x63\xf7\xaa\xc4\x2d\x72\x2e\xa3\xdb\x8d\xa6\x53\x99\xe1\xe2\x50\xf8\x6f\x9f\xc9\x1d\x4f\x78\x54\xaf\xb3\xd2\xd5\x61\x56\xd1\xce\xca\xf1\xda\x75\xb1\xa7\xc1\x1d\x88\xed\x6a\xa4\x66\xda\xed\x1e\xeb\xeb\x2f\x28\x80\xe0\x41\x3e\xee\xc7\xad\xf1\xf0\x5d\x6d\xe0\x20\x22\x40\xbd\xe8\xdc\x54\x51\xb6\x5a\xc5\x44\xf6\x43\x66\xec\x42\xc8\xe7\x33\x19\x8f\xae\x14\xac\x34\xb7\x55\xf2\xc5\x89\xf5\x5b\xb4\xea\x8d\x5c\xcc\xd0\x65\xe8\x1d\xd8\xd8\x80\x4b\xbd\x99\x60\x4c\x87\x4b\x3f\x84\x67\x94\xaa\xef\x29\x8d\x85\xcd\x11\x85\xcc\x3f\x18\xa4\x07\xa0\x60\x89\xba\x53\x9d\x7e\x80\x1d\x9c\x98\x29\x7f\x20\x8c\xdc\x35\x9e\xb9\x68\x72\x5b\xaf\x40\xb0\xaa\x83\x26\xed\x15\x3d\x7b\xc8\x44\xb6\x6e\xca\x3c\x84\xca\x95\xb4\x4d\x0e\x81\xa8\xaa\x1f\x9c\x99\x31\xba\x90\x9d\xee\xd9\xc7\xef\x98";

int main(void){
    OSSL_PARAM_BLD *paramBld = NULL;
    OSSL_PARAM *param = NULL;
    BIGNUM *n = NULL, *e = NULL, *d = NULL;
    size_t sig_size;
    EVP_PKEY_CTX *ctx = NULL;
    EVP_PKEY *privkey = NULL;
    RSA *rsa;
    unsigned char* sig;
    EVP_MD_CTX *md_ctx = NULL;
    uint8_t temp;
    const unsigned char digest[DIGEST_SIZE] = "\x9c\xf9\xcf\xf0\x11\xac\x22\xd7\xdd\x79\x4c\x3d\xf3\xd4\xe5\x65\x9f\x94\x0e\x41\xc6\x1b\x3b\xac\xae\xe0\xef\x14\xb8\xcb\x7d\xa5";
 
    //FILE *f = fopen("lol.pem", "rt");
    //privkey = EVP_RSA_gen(2048);
    //RSA *rsa_key = RSA_new();
    OpenSSL_add_all_algorithms();
    ERR_load_crypto_strings();

    //// Generate a 2048-bit RSA key
    //e = BN_new();
    //BN_set_word(e, 65537);  // RSA_F4 is a commonly used public exponent
    //RSA_generate_key_ex(rsa_key, 2048, e, NULL);
    ////privkey = PEM_read_PrivateKey(f, NULL, NULL, NULL);
    //if(!privkey) goto DONE;
    //puts("priv key generated");

    //FILE *private_key_file = fopen("private_key.pem", "wb");
    //if (!private_key_file) {
    //    perror("Error opening private key file");
    //    RSA_free(rsa_key);
    //    ERR_free_strings();
    //    return 1;
    //}

    //PEM_write_RSAPrivateKey(private_key_file, rsa_key, NULL, NULL, 0, NULL, NULL);
    //fclose(private_key_file);
    //privkey = EVP_PKEY_new();
    //EVP_PKEY_assign_RSA(privkey, rsa);
    //BIO *bio = BIO_new(BIO_s_mem());

    FILE *private_key_file = fopen("private_key.pem", "rb");
    if (!private_key_file) {
        perror("Error opening private key file");
        ERR_print_errors_fp(stderr);
        EVP_cleanup();
        ERR_free_strings();
        return 1;
    }

    privkey = EVP_PKEY_new();
    if (!PEM_read_PrivateKey(private_key_file, &privkey, NULL, NULL)) {
        perror("Error loading private key");
        ERR_print_errors_fp(stderr);
        fclose(private_key_file);
        EVP_cleanup();
        ERR_free_strings();
        return 1;
    }

    fclose(private_key_file);

    md_ctx = EVP_MD_CTX_new();


    if ((ctx = EVP_PKEY_CTX_new(privkey, NULL)) == NULL) goto DONE;
    puts("context initiated");
    if (EVP_PKEY_sign_init(ctx) <= 0) puts("sign init"); goto DONE;
    puts("sign initiated");
    if (EVP_PKEY_CTX_set_rsa_padding(ctx, RSA_PKCS1_PADDING) <= 0) puts("set padding"); goto DONE;
    if (EVP_PKEY_CTX_set_signature_md(ctx, EVP_sha256()) <= 0) puts("set sig"); goto DONE;
    //if (EVP_PKEY_verify(ctx, NULL, sig_size, digest, DIGEST_SIZE) <= 0) goto DONE;
    puts("calling first sign");
    if (EVP_PKEY_sign(ctx, NULL, &sig_size, digest, DIGEST_SIZE) <= 0) puts("first sign"); goto DONE;
    puts("mallocing");
    sig = OPENSSL_malloc(sig_size);
    puts("trying to sign");
    if (EVP_PKEY_sign(ctx, sig, &sig_size, digest, DIGEST_SIZE) <= 0) puts("fail"); goto DONE;


    puts("digest computed successfully");

DONE:
    return 0;
}
