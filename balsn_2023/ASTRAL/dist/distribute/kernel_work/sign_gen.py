#!/usr/bin/env python

from Crypto.PublicKey import RSA
import binascii
from Crypto.Signature.pkcs1_15 import PKCS115_SigScheme
from Crypto.Hash import SHA256
from Crypto.Signature import pss

code = b"\x40\x03\x00\x41\x19\x00\x34\x00\x00\x00\x00\x00\x01\x20\x02\x30\x01\x01\x5a\x21\x44\x04\x00\x40\x0a\x00\xfd\x40\x1c\x00\xfd\x56\x00\x56\x11\xff\x30\x02\x08\x5a\x2b\x42\xf3\xff\x27\x99\x5a\x89\x44\xec\xff\x28\x10\x50\x10\x2f\x90\xfd\x40\x01\x00\xfd\x30\x09\x10\x5a\x9b\x42\xd9\xff\x50\x10\x59\x0a\x30\x02\x08\x27\x89\x50\x20\x2f\x90\x30\x03\x02\x51\x3e\x59\xe3\x37\x00\x63\x31\x93\xa9\xd1\x8f\x5e\xa5\x30\x01\x10\x59\xa2\xfe\x20\x31\x30\x00\x08\x50\x02\x2f\x82\x5a\x81\x44\xa7\xff\x51\x02\x2f\x92\x27\x00\x30\x02\x10\x59\xb1\x51\x21\xfe\xfd";

e_bytes = b"\x01\x00\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"

key_file = open("lol.pem", "r")
key = RSA.importKey(key_file.read())
public_key = key.publickey()
n_bytes = binascii.unhexlify(hex(key.n)[2:].encode())
#d_bytes = binascii.unhexlify(hex(key.d)[2:].encode())
print(hex(key.n))
print(hex(key.e))
print(hex(key.d))

#with open ("lol.pem", "w") as prv_file:
#    print("{}".format(key.exportKey().decode('utf-8')), file=prv_file)
#
#with open ("lol_pub.pem", "w") as pub_file:
#    print("{}".format(public_key.exportKey().decode('utf-8')), file=pub_file)

to_hash = n_bytes + e_bytes + b'\x00'*0x100 + code

with open("sig", "wb+") as chef:
    chef.write(to_hash)
    chef.close()

hash = SHA256.new(to_hash)

print(hash.hexdigest())

#signer = PKCS115_SigScheme(key)
signature = pss.new(key).sign(hash)
print("Signature: ", binascii.hexlify(signature))
